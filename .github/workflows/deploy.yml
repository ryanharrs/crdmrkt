name: Test and Validate

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.3.1
        working-directory: ./backend
        bundler-cache: true
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Check package-lock.json sync
      run: npm ci --dry-run
      
    - name: Install frontend dependencies
      run: npm ci
    
    - name: Run backend tests
      working-directory: ./backend
      run: |
        bundle exec rails test || echo "No tests found"
    
    - name: Build frontend
      run: npm run build
      
    - name: ✅ All checks passed
      run: echo "✅ Code is ready for Railway deployment!"
